{% extends "layout.html" %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block content %}
  <div class="page-title">
    <div>
      <h2>Dashboard</h2>
      <div class="subtle">Events per venue (top 10)</div>
    </div>
  </div>

  <div class="grid two">
    <div class="card">
      <div id="chartWrap" class="chart-wrap loading">
        <canvas id="chart" height="120"></canvas>
        <div class="loading-text">Loadingâ€¦</div>
      </div>
    </div>
    <div class="card">
      <h3>Tips</h3>
      <p class="subtle">Add, edit, or delete events from the Events page. Your changes update this chart on refresh.</p>
      <ul>
        <li>Top 10 venues by event count</li>
        <li>Data fetched from <code>/api/events_per_venue</code></li>
      </ul>
    </div>
  </div>

  <script>
    const wrap = document.getElementById('chartWrap');
    const ctx  = document.getElementById('chart').getContext('2d');

    fetch('{{ url_for("api_events_per_venue") }}')
      .then(r => r.json())
      .then(({labels, counts}) => {
        wrap.classList.remove('loading');
        new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [{ label: 'Events', data: counts, borderWidth: 1 }] },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: '#9bb0d3' }, grid: { color: 'rgba(255,255,255,.06)' } },
              y: { ticks: { color: '#9bb0d3' }, grid: { color: 'rgba(255,255,255,.06)' } }
            }
          }
        });
      })
      .catch(err => {
        wrap.classList.remove('loading');
        console.error(err);
        const msg = document.createElement('div');
        msg.className = 'subtle';
        msg.textContent = 'Failed to load chart.';
        ctx.canvas.replaceWith(msg);
      });
  </script>
{% endblock %}